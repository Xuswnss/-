# 서버 2개: Core(블록체인) + Backend(연구)
# Backend는 Core API를 호출하므로 core 가 먼저 기동됩니다.

services:
  core:
    build:
      context: ./core
      dockerfile: Dockerfile
    container_name: core
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - NODE_ENV=production
      # 테스트넷 연결 (필요 시 .env 파일로 오버라이드)
      - XRPL_NETWORK=testnet
      - XRPL_WSS_URL=wss://s.altnet.rippletest.net:51233
      # 에스크로 지갑 (env_file에서 로드, 없으면 아래 기본값)
      # - ESCROW_WALLET_SECRET=s...
      # - ESCROW_WALLET_ADDRESS=r...
    env_file: ./core/.env.example
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/summary',r=>process.exit(r.statusCode===200?0:1)).on('error',()=>process.exit(1))"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: backend
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      # Core(서버 1) URL — 컨테이너 내부에서는 서비스 이름으로 접근
      - CORE_BASE_URL=http://core:3000/api
      - SPRING_DATASOURCE_URL=jdbc:h2:mem:uniqdata
      - SPRING_H2_CONSOLE_ENABLED=true
    depends_on:
      - core
